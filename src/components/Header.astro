---
import { Icon } from "astro-icon/components";

const baseUrl = import.meta.env.BASE_URL;
const withBase = (path: string) => `${baseUrl.replace(/\/$/, "")}/${path.replace(/^\//, "")}`;
const basePath = baseUrl.replace(/\/$/, "") || "";
const pathname = Astro.url.pathname;
const rawPath = basePath ? pathname.replace(new RegExp(`^${basePath.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")}`), "") : pathname;
const currentPath = ("/" + (rawPath || "").replace(/^\/+|\/+$/g, "").replace(/\/index\.html$/i, "")).replace(/\/+/g, "/") || "/";

const navItems = [
  { href: withBase("/"), label: "Главная", path: "/" },
  { href: withBase("/about"), label: "Об исследовании", path: "/about" },
  { href: withBase("/team"), label: "Команда", path: "/team" },
  { href: withBase("/contact"), label: "Контакты", path: "/contact" },
];
const auditHref = `${withBase("/")}#audit`;
const legalLine = "ИП Дементьева К.С. · ОГРНИП 325710000025380";
---
<header class="site-header w-full">
  <div class="container-header flex h-full items-center justify-between gap-6">
    <div class="header-logo-block flex flex-col items-start gap-0.5">
      <a href={withBase("/")} class="header-logo focus-ring group flex flex-col items-start gap-0.5 rounded-xl py-1">
        <span class="header-logo-text text-lg font-bold tracking-tight sm:text-xl">
          Лаборатория ИИ СКОЛКОВО
        </span>
        <span class="text-[10px] font-medium uppercase tracking-[0.25em] text-muted sm:text-xs">Исследование ИИ и АСУ</span>
      </a>
      <p class="header-legal mt-1 text-[10px] leading-tight text-muted/90 sm:text-[11px]" role="doc-tip">{legalLine}</p>
    </div>

    <nav class="hidden items-center gap-2 lg:flex">
      {navItems.map((item) => {
        const isActive = currentPath === item.path;
        return (
          <a
            class={`nav-link rounded-lg px-4 py-2.5 text-sm font-medium transition focus-ring ${
              isActive ? "text-text" : "text-muted hover:text-text"
            }`}
            href={item.href}
            aria-current={isActive ? "page" : undefined}
          >
            {item.label}
          </a>
        );
      })}
      <a
        href={auditHref}
        class="button button-primary ml-2 shrink-0 focus-ring whitespace-nowrap text-sm"
      >
        Углубленный аудит за символическую стоимость
      </a>
    </nav>

    <button
      class="header-burger-wrapper lg:hidden flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-xl border border-white/10 bg-white/5 text-text focus-ring transition hover:bg-white/10"
      aria-label="Открыть меню"
      data-menu-toggle
      type="button"
    >
      <span class="header-burger" aria-hidden="true">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </button>
  </div>

  <!-- Mobile menu: overlay + slide panel -->
  <div class="mobile-menu-overlay" data-menu-overlay id="mobile-menu-overlay">
    <div class="mobile-menu-panel relative" data-menu-content>
      <button
        type="button"
        aria-label="Закрыть меню"
        data-menu-close
        class="absolute right-4 top-4 flex h-11 w-11 items-center justify-center rounded-xl border border-white/10 bg-white/5 text-text focus-ring hover:bg-white/10 lg:hidden"
      >
        <Icon name="lucide:x" class="h-5 w-5" aria-hidden="true" />
      </button>
      <nav class="flex flex-col gap-1">
        {navItems.map((item) => {
          const isActive = currentPath === item.path;
          return (
            <a
              class={`rounded-xl px-4 py-4 text-lg font-semibold transition focus-ring ${isActive ? "bg-white/10 text-text" : "text-muted hover:bg-white/5 hover:text-text"}`}
              href={item.href}
              data-menu-link
              aria-current={isActive ? "page" : undefined}
            >
              {item.label}
            </a>
          );
        })}
        <a
          href={auditHref}
          class="button button-primary mt-4 w-full justify-center focus-ring"
          data-menu-link
        >
          Углубленный аудит за символическую стоимость
        </a>
      </nav>
      <div class="mt-auto border-t border-stroke pt-6 space-y-2">
        <p class="text-[11px] text-muted/90">{legalLine}</p>
        <p class="text-xs font-medium uppercase tracking-wider text-muted">Исследование интеграции ИИ и АСУ</p>
      </div>
    </div>
  </div>
</header>
